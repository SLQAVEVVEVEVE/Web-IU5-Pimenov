<%# Main cart container %>
<div class="cart-container">
  <%# Cart header with title and metadata %>
  <div class="cart-header">
    <h1 class="cart-title">–ó–∞—è–≤–∫–∞ ‚Ññ<%= @request.id %></h1>
    <p class="cart-meta">
      –ü–æ–∑–∏—Ü–∏–π: <strong><%= @request.request_services.count %></strong> ‚Ä¢
      –í—Å–µ–≥–æ —à—Ç—É–∫: <strong><%= @request.request_services.sum(:quantity) %></strong>
    </p>
  </div>

  <%# Check if cart has items %>
  <% if @request.request_services.any? %>
    <%# Cart items list %>
    <ul class="cart-items">
      <% @request.request_services.includes(:service).each do |item| %>
        <%
          is_valid = item.service.present?
          service = item.service if is_valid
        %>

        <li class="cart-item <%= 'cart-item--invalid' unless is_valid %>">
          <div class="cart-item__image">
            <%= is_valid ? 'üì¶' : '‚ùì' %>
          </div>

          <div class="cart-item__details">
            <h3 class="cart-item__title">
              <%= is_valid ? service.name : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É—Å–ª—É–≥–∞ ##{item.service_id}" %>
            </h3>

            <% if is_valid %>
              <%= form_for item, url: request_item_path(request_id: @request, id: item), method: :patch, html: { class: 'cart-item-form' } do |f| %>
                <div class="cart-item__fields">
                  <div class="cart-item__field">
                    <label class="cart-item__label">–î–ª–∏–Ω–∞ (–º):</label>
                    <%= f.number_field :length_m, class: 'cart-item__input', step: 0.1, min: 0.1 %>
                  </div>
                  <div class="cart-item__field">
                    <label class="cart-item__label">–ù–∞–≥—Ä—É–∑–∫–∞ (–∫–ù/–º):</label>
                    <%= f.number_field :load_kn_m, class: 'cart-item__input', step: 0.1, min: 0.1 %>
                  </div>
                  <div class="cart-item__field">
                    <label class="cart-item__label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                    <%= f.number_field :quantity, class: 'cart-item__input', min: 1 %>
                  </div>
                </div>
                <div class="cart-item__form-actions">
                  <%= f.submit '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', class: 'btn btn--small' %>
                </div>
              <% end %>
            <% else %>
              <div class="cart-item__meta">
                <span>–≠—Ç–∞ –ø–æ–∑–∏—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞</span>
              </div>
            <% end %>
          </div>

          <div class="cart-item__actions">
            <% if is_valid && service.respond_to?(:price) && service.price.present? %>
              <span class="cart-item__price">
                <%= number_to_currency(item.quantity * service.price.to_f, unit: '‚ÇΩ', format: "%n %u") %>
              </span>
            <% end %>

            <%= button_to '‚úï',
                        request_item_path(request_id: @request, id: item),
                        method: :delete,
                        data: { turbo_confirm: '–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏–∑ –∑–∞—è–≤–∫–∏?' },
                        class: 'cart-item__remove',
                        title: '–£–¥–∞–ª–∏—Ç—å' %>
          </div>
        </li>
      <% end %>
    </ul>

    <%# Calculate total price %>
    <%
      total_price = @request.request_services.sum do |item|
        if item.service&.respond_to?(:price) && item.service.price.present?
          item.quantity * item.service.price.to_f
        else
          0
        end
      end
    %>

    <%# Cart summary %>
    <div class="cart-summary">
      <div class="cart-summary__row">
        <span>–ò—Ç–æ–≥–æ –ø–æ–∑–∏—Ü–∏–π:</span>
        <span><strong><%= @request.request_services.count %></strong></span>
      </div>
      <div class="cart-summary__row">
        <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
        <span><strong><%= @request.request_services.sum(:quantity) %></strong> —à—Ç.</span>
      </div>

      <% if total_price > 0 %>
        <div class="cart-summary__row cart-summary__total">
          <span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
          <span><%= number_to_currency(total_price, unit: '‚ÇΩ', format: "%n %u") %></span>
        </div>
      <% end %>

      <div class="cart-actions">
        <%= link_to '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏', root_path, class: 'btn btn--outline' %>
        <%= link_to '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑', '#', class: 'btn btn--primary' %>
      </div>
    </div>
  <% else %>
    <%# Empty cart state %>
    <div class="empty-cart">
      <div class="empty-cart__icon">üõí</div>
      <h2 class="empty-cart__title">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
      <p class="empty-cart__text">–í –≤–∞—à–µ–π –∑–∞—è–≤–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏.</p>
      <%= link_to '–í –∫–∞—Ç–∞–ª–æ–≥', root_path, class: 'btn btn--primary' %>
    </div>
  <% end %>
</div>