---
openapi: 3.0.1
info:
  title: Beam Deflection API
  version: v1
  description: |
    JSON API for managing services, requests and moderation workflows.
    Authorization is handled via JWT tokens (Bearer), issued by /api/auth/sign_in or sign_up.
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
security:
- bearerAuth: []
paths:
  "/api/auth/sign_in":
    post:
      summary: Sign in and receive JWT
      tags:
      - Auth
      parameters: []
      responses:
        '200':
          description: Signed in
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    type: object
                    properties:
                      id:
                        type: integer
                      email:
                        type: string
                      moderator:
                        type: boolean
        '401':
          description: Invalid credentials
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  example: secret123
  "/api/auth/sign_up":
    post:
      summary: Register and receive JWT
      tags:
      - Auth
      parameters: []
      responses:
        '201':
          description: User created
        '422':
          description: Validation error
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - email
              - password
              - password_confirmation
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
                password_confirmation:
                  type: string
  "/api/auth/sign_out":
    post:
      summary: Sign out (client should discard token)
      tags:
      - Auth
      security:
      - bearerAuth: []
      responses:
        '204':
          description: Signed out
  "/api/me":
    get:
      summary: Current user profile
      tags:
      - Me
      security:
      - bearerAuth: []
      responses:
        '200':
          description: Profile returned
    put:
      summary: Update current user credentials
      tags:
      - Me
      security:
      - bearerAuth: []
      parameters: []
      responses:
        '200':
          description: Updated
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
                password_confirmation:
                  type: string
  "/api/request_services":
    post:
      summary: Add service to current draft request
      tags:
      - Requests
      security:
      - bearerAuth: []
      parameters: []
      responses:
        '201':
          description: Service added to cart
        '401':
          description: Unauthorized
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - service_id
              - quantity
              properties:
                service_id:
                  type: integer
                quantity:
                  type: integer
                  minimum: 1
  "/api/requests/{id}/form":
    put:
      summary: Validate draft and mark as formed (user only)
      tags:
      - Requests
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Request formed
        '403':
          description: Cannot form foreign request
  "/api/requests/{id}/complete":
    put:
      summary: Complete formed request (moderator only)
      tags:
      - Requests
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Request completed
        '403':
          description: Requires moderator role
  "/api/services":
    get:
      summary: List services (public)
      tags:
      - Services
      responses:
        '200':
          description: Services returned
    post:
      summary: Create service (moderator only)
      tags:
      - Services
      security:
      - bearerAuth: []
      parameters: []
      responses:
        '201':
          description: Service created
        '403':
          description: Forbidden for non-moderators
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
              - name
              - material
              - elasticity_gpa
              - inertia_cm4
              - allowed_deflection_ratio
              properties:
                name:
                  type: string
                material:
                  type: string
                  enum:
                  - wooden
                  - steel
                  - reinforced_concrete
                elasticity_gpa:
                  type: number
                inertia_cm4:
                  type: number
                allowed_deflection_ratio:
                  type: integer
  "/api/services/{id}":
    get:
      summary: Fetch service details (public)
      tags:
      - Services
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Service found
    put:
      summary: Update service (moderator only)
      tags:
      - Services
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: Service updated
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                material:
                  type: string
                allowed_deflection_ratio:
                  type: integer
    delete:
      summary: Delete service (moderator only)
      tags:
      - Services
      security:
      - bearerAuth: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '204':
          description: Service deleted
servers:
- url: "{scheme}://{host}"
  variables:
    scheme:
      default: http
    host:
      default: localhost:3000
